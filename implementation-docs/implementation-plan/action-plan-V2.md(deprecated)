# ğŸ“Š Plano Completo de AdequaÃ§Ã£o - Dashboard EMEB Educar

## 1. VisÃ£o Geral do Projeto

### 1.1 Objetivo
Implementar sistema de dashboards com controle de acesso baseado em roles para visualizaÃ§Ã£o de indicadores educacionais, com 4 nÃ­veis de acesso distintos:
- **DIRETORIA**: Acesso aos dados de sua escola
- **SEC_EDUC_MUN**: Acesso Ã s escolas municipais do municÃ­pio
- **SEC_EDUC_EST**: Acesso Ã s escolas estaduais do estado
- **SEC_SEG_PUB**: Acesso a denÃºncias especÃ­ficas das escolas municipais e estaduais do estado

### 1.2 Indicadores a Implementar
1. **PresenÃ§a**: Taxa atual vs total de alunos (Radial Chart)
2. **DenÃºncias**: Bullying e Infraestrutura - TRATADA vs PENDENTE (Bar Chart Stacked)
3. **Socioemocional**: Scores por dimensÃ£o (Radar Chart)

## 2. Arquitetura da SoluÃ§Ã£o

### 2.1 Backend (Supabase)
- **Banco de Dados**: PostgreSQL com estrutura multi-tenant
- **AutenticaÃ§Ã£o**: Supabase Auth
- **Realtime**: Supabase Realtime para atualizaÃ§Ãµes
- **RPCs**: Functions para agregaÃ§Ã£o de dados com controle de acesso
- **RLS**: Row Level Security para isolamento de dados

### 2.2 Frontend
- **Framework**: Next.js 14+ com App Router
- **UI Components**: shadcn/ui
- **GrÃ¡ficos**: Recharts (integrado com shadcn/ui)
- **EstilizaÃ§Ã£o**: Tailwind CSS
- **Estado**: Zustand + Tanstack Query
- **Deploy**: Netlify

## 3. AdequaÃ§Ãµes no Banco de Dados

### 3.1 Novas Tabelas
- [x] `role_permissions`: Controle de roles especiais
- [x] Ãndices para otimizaÃ§Ã£o de consultas

### 3.2 AlteraÃ§Ãµes em Tabelas Existentes
- [x] `user_tenant_mapping`: Adicionar special_role_id e access_scope
- [x] `instituicoes`: Adicionar co_uf, co_municipio, tp_dependencia

### 3.3 FunÃ§Ãµes (RPCs)
- [x] `rpc_dashboard_presenca`: AgregaÃ§Ã£o de dados de presenÃ§a
- [x] `rpc_dashboard_denuncias`: AgregaÃ§Ã£o de denÃºncias por categoria
- [x] `rpc_dashboard_sentimento`: AgregaÃ§Ã£o de scores socioemocionais
- [x] `check_user_dashboard_access`: VerificaÃ§Ã£o de permissÃµes
- [x] `get_user_accessible_schools`: Listar escolas acessÃ­veis ao usuÃ¡rio

### 3.4 Triggers para Realtime
- [x] `notify_dashboard_presenca_change`: AtualizaÃ§Ã£o de presenÃ§a
- [x] `notify_dashboard_denuncias_change`: AtualizaÃ§Ã£o de denÃºncias
- [x] `notify_dashboard_sentimento_change`: AtualizaÃ§Ã£o socioemocional

## 4. Componentes Frontend

### 4.1 Estrutura de Pastas (Next.js App Router)
```
app/
â”œâ”€â”€ (auth)/
â”‚   â”œâ”€â”€ login/
â”‚   â””â”€â”€ layout.tsx
â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ page.tsx
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ presence-chart.tsx
â”‚   â”‚   â”œâ”€â”€ complaints-chart.tsx
â”‚   â”‚   â”œâ”€â”€ emotional-chart.tsx
â”‚   â”‚   â””â”€â”€ school-selector.tsx
â”‚   â””â”€â”€ [schoolId]/
â”‚       â””â”€â”€ page.tsx
â”œâ”€â”€ api/
â”‚   â””â”€â”€ dashboard/
â”‚       â”œâ”€â”€ presence/route.ts
â”‚       â”œâ”€â”€ complaints/route.ts
â”‚       â””â”€â”€ emotional/route.ts
â””â”€â”€ layout.tsx

components/
â”œâ”€â”€ ui/
â”‚   â”œâ”€â”€ chart.tsx (shadcn/ui)
â”‚   â”œâ”€â”€ card.tsx
â”‚   â”œâ”€â”€ select.tsx
â”‚   â””â”€â”€ ...
â””â”€â”€ charts/
    â”œâ”€â”€ radial-chart.tsx
    â”œâ”€â”€ bar-chart-stacked.tsx
    â””â”€â”€ radar-chart.tsx
```

### 4.2 Componentes de GrÃ¡ficos (shadcn/ui + Recharts)

#### PresenÃ§a (Radial Chart)
- Componente: `@/components/ui/chart` com RadialBarChart
- Props: presentes, total, porcentagem
- Cores: Verde (presente) / Cinza (ausente)

#### DenÃºncias (Bar Chart Stacked)
- Componente: `@/components/ui/chart` com BarChart
- Props: meses, categorias, status (tratada/pendente)
- Cores: Azul (tratada) / Laranja (pendente)

#### Socioemocional (Radar Chart)
- Componente: `@/components/ui/chart` com RadarChart
- Props: dimensÃµes, scores (0-10)
- Cores: Gradiente de cores por dimensÃ£o

### 4.3 Fluxo de AutenticaÃ§Ã£o
1. Login via Supabase Auth
2. Middleware verifica role do usuÃ¡rio
3. Redirect para dashboard apropriado
4. Carregamento de escolas permitidas
5. SeleÃ§Ã£o de escola(s) para visualizaÃ§Ã£o

## 5. ConfiguraÃ§Ã£o do Deploy (Netlify)

### 5.1 VariÃ¡veis de Ambiente
```env
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
```

### 5.2 Build Settings
```toml
[build]
  command = "npm run build"
  publish = ".next"

[build.environment]
  NEXT_TELEMETRY_DISABLED = "1"

[[plugins]]
  package = "@netlify/plugin-nextjs"

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200
```

### 5.3 Headers de SeguranÃ§a
```toml
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"
```

## 6. Cronograma de ImplementaÃ§Ã£o

### Fase 1: Backend (3-4 dias)
- [ ] Dia 1: Criar tabelas e alteraÃ§Ãµes no BD
- [ ] Dia 2: Implementar RPCs principais
- [ ] Dia 3: Testes e ajustes das RPCs
- [ ] Dia 4: Configurar triggers para realtime

### Fase 2: Frontend Base (3-4 dias)
- [ ] Dia 5: Setup Next.js + shadcn/ui
- [ ] Dia 6: Implementar autenticaÃ§Ã£o e middleware
- [ ] Dia 7: Criar layouts e rotas
- [ ] Dia 8: Componente de seleÃ§Ã£o de escolas

### Fase 3: Componentes de GrÃ¡ficos (2-3 dias)
- [ ] Dia 9: Implementar grÃ¡ficos com shadcn/ui
- [ ] Dia 10: IntegraÃ§Ã£o com RPCs
- [ ] Dia 11: Realtime updates

### Fase 4: Deploy e Testes (2 dias)
- [ ] Dia 12: Deploy no Netlify
- [ ] Dia 13: Testes finais e ajustes

## 7. ConsideraÃ§Ãµes de SeguranÃ§a

### 7.1 Backend
- RLS ativado em todas as tabelas
- RPCs com SECURITY DEFINER
- ValidaÃ§Ã£o de roles em todas as funÃ§Ãµes
- Logs de auditoria para acessos

### 7.2 Frontend
- SanitizaÃ§Ã£o de inputs
- Rate limiting nas APIs
- HTTPS obrigatÃ³rio
- CSP headers configurados

## 8. Monitoramento e ManutenÃ§Ã£o

### 8.1 MÃ©tricas a Monitorar
- Taxa de erro das RPCs
- Tempo de resposta dos dashboards
- Uso de banda/recursos
- Acessos por role

### 8.2 Backups
- Backup diÃ¡rio do BD (Supabase)
- Versionamento de cÃ³digo (Git)
- Snapshots de configuraÃ§Ã£o

## 9. DocumentaÃ§Ã£o NecessÃ¡ria

### 9.1 Para Desenvolvedores
- [ ] README.md com setup local
- [ ] DocumentaÃ§Ã£o das RPCs
- [ ] Guia de contribuiÃ§Ã£o
- [ ] Exemplos de uso dos componentes

### 9.2 Para UsuÃ¡rios
- [ ] Manual de uso por role
- [ ] FAQ comum
- [ ] VÃ­deos tutoriais
- [ ] Guia de troubleshooting

## 10. Riscos e MitigaÃ§Ãµes

| Risco | Probabilidade | Impacto | MitigaÃ§Ã£o |
|-------|--------------|---------|-----------|
| Performance com muitas escolas | MÃ©dia | Alto | Implementar paginaÃ§Ã£o e cache |
| Complexidade das permissÃµes | Alta | MÃ©dio | Testes extensivos por role |
| Limites do Netlify | Baixa | MÃ©dio | Monitorar uso e otimizar build |
| Dados inconsistentes | MÃ©dia | Alto | ValidaÃ§Ãµes e constraints no BD |

## 11. Checklist de Entrega

### Backend
- [ ] Todas as tabelas criadas
- [ ] RPCs funcionando corretamente
- [ ] Triggers configurados
- [ ] Testes de permissÃ£o por role
- [ ] DocumentaÃ§Ã£o das APIs

### Frontend
- [ ] AutenticaÃ§Ã£o funcionando
- [ ] Todos os grÃ¡ficos implementados
- [ ] Responsividade testada
- [ ] Performance otimizada
- [ ] Acessibilidade verificada

### Deploy
- [ ] VariÃ¡veis de ambiente configuradas
- [ ] Build sem erros
- [ ] SSL configurado
- [ ] Monitoramento ativo
- [ ] Backup configurado

## 12. Contatos e ResponsÃ¡veis

- **Backend/BD**: [ResponsÃ¡vel]
- **Frontend**: [ResponsÃ¡vel]
- **DevOps/Deploy**: [ResponsÃ¡vel]
- **Testes**: [ResponsÃ¡vel]
- **DocumentaÃ§Ã£o**: [ResponsÃ¡vel]

---

**Status**: ğŸŸ¡ Em Desenvolvimento
**Ãšltima AtualizaÃ§Ã£o**: [Data]
**VersÃ£o**: 1.0.0